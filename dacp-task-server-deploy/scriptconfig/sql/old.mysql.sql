UPDATE proc_schedule_info INNER JOIN( SELECT xmlid, TRUNCATE(SUM(TIME_TO_SEC(TIMEDIFF(exec_time, start_time)))/COUNT(xmlid)/60,0) evra_time FROM proc_schedule_log WHERE LENGTH(exec_time) > 0 AND LENGTH(start_time) > 0 AND DATEDIFF(CURDATE(), start_time) < 30 and valid_flag='0' GROUP BY xmlid HAVING evra_time >=0) T ON proc_schedule_info.xmlid = T.xmlid SET proc_schedule_info.dura_max = IF(T.evra_time = 0, 1, T.evra_time)